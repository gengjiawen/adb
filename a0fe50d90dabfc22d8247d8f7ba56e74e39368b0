{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "0db2e1f0_129ce233",
        "filename": "sysdeps.h",
        "patchSetId": 1
      },
      "lineNbr": 138,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2024-03-19T22:30:53Z",
      "side": 1,
      "message": "i think the right fix for all of these is to use `#pragma clang poison foo` instead. that\u0027s the intention here (which is why we need _something_), but this code predates that better way of doing it.",
      "revId": "a0fe50d90dabfc22d8247d8f7ba56e74e39368b0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f1fba748_6420f6ab",
        "filename": "sysdeps.h",
        "patchSetId": 1
      },
      "lineNbr": 138,
      "author": {
        "id": 1307979
      },
      "writtenOn": "2024-03-19T23:34:57Z",
      "side": 1,
      "message": "I tried this out - the poison pragma triggers an error for the identifier no matter in what context it appears, so it doesn\u0027t solve the original issue and also gives additional errors in absl/synchronization/mutex.h (which has `bool write` as a parameter) and in openssl/bio.h (which has a struct field named `write`).\n\n`#pragma clang poison ::write` gives \"error: can only poison identifier tokens\".\n\nNext, I tried a template that always gives an error when instantiated:\n\n```\ntemplate \u003ctypename... Args, typename T \u003d void\u003e\ninline ssize_t write(Args\u0026\u0026... args) {\n    static_assert(!std::is_same_v\u003cstd::void_t\u003cArgs...\u003e, T\u003e,\n                  \"write() not allowed\");\n    return 0;\n}\n```\n\nbut this doesn\u0027t work if the argument types match exactly - the standalone function takes precedence over the template and doesn\u0027t trigger the compilation error. Importing the template from another namespace also doesn\u0027t work (as expected).\n\n`#pragma clang attribute` combined with the `warning` attribute seemed promising, as this can be temporarily disabled with `#pragma clang diagnostic ignored -Wattribute-warning`, but I can only apply this to entire headers such as `\u003cunistd.h\u003e` - it marks functions like `dup2` and `access`. It also requires `sysdeps.h` to always be included first, which is currently not the case.\n\nThere\u0027s an \"interrupter\" library defined in frameworks base which uses `dlsym` to interpose these functions, but I don\u0027t think this would be supported on Windows:\nhttps://source.corp.google.com/h/android/platform/superproject/main/+/main:frameworks/base/cmds/interrupter/\n\nAny other ideas? Maybe we need to enforce this with the CheckContents linter?",
      "parentUuid": "0db2e1f0_129ce233",
      "revId": "a0fe50d90dabfc22d8247d8f7ba56e74e39368b0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "38db9b5b_205a9cdb",
        "filename": "sysdeps.h",
        "patchSetId": 1
      },
      "lineNbr": 138,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2024-03-19T23:50:49Z",
      "side": 1,
      "message": "\u003e I tried this out - the poison pragma triggers an error for the identifier no matter in what context it appears, so it doesn\u0027t solve the original issue and also gives additional errors in absl/synchronization/mutex.h (which has bool write as a parameter) and in openssl/bio.h (which has a struct field named write).\n\nyeah, now you mention it, there _was_ a reason why we\u0027d never switched :-(\n\nhmm... can we factor the protobuf stuff out into a file that _doesn\u0027t_ need sysdeps? other than the test, the other two places protobuf is pulled in are two of the biggest and hairiest files in adb. but we\u0027re only using _text_ protos, iirc, so we can probably get away with having proto stuff sealed away and just returning strings?",
      "parentUuid": "f1fba748_6420f6ab",
      "revId": "a0fe50d90dabfc22d8247d8f7ba56e74e39368b0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3b63da1b_a81667ab",
        "filename": "sysdeps.h",
        "patchSetId": 1
      },
      "lineNbr": 138,
      "author": {
        "id": 1307979
      },
      "writtenOn": "2024-03-20T00:12:49Z",
      "side": 1,
      "message": "The header that mentions `write` is indirectly pulled in by the generated proto headers, which would be pretty difficult to encapsulate in separate files. This is the error I get locally:\n\n```\nIn file included from packages/modules/adb/client/adb_install.cpp:40:\nIn file included from packages/modules/adb/client/fastdeploy.h:21:\nIn file included from out/soong/.intermediates/packages/modules/adb/libfastdeploy_host/linux_glibc_x\n86_64_static/e560d7b19ebf7276b3e850d3d346dec8/gen/proto/packages/modules/adb/fastdeploy/proto/ApkEnt\nry.pb.h:24:\nIn file included from external/protobuf/src/google/protobuf/io/coded_stream.h:134:\nIn file included from external/abseil-cpp/absl/strings/cord.h:80:\nIn file included from external/abseil-cpp/absl/crc/internal/crc_cord_state.h:23:\nIn file included from external/abseil-cpp/absl/crc/crc32c.h:32:\nIn file included from external/abseil-cpp/absl/strings/str_format.h:83:\nIn file included from external/abseil-cpp/absl/strings/internal/str_format/arg.h:37:\nIn file included from external/abseil-cpp/absl/strings/internal/str_format/extension.h:27:\nexternal/abseil-cpp/absl/strings/internal/str_format/output.h:75:8: error: no member named \u0027___xxx_w\nrite\u0027 in \u0027std::basic_ostream\u003cchar\u003e\u0027\n   75 |   out-\u003ewrite(s.data(), static_cast\u003cstd::streamsize\u003e(s.size()));\n      |   ~~~  ^\npackages/modules/adb/sysdeps.h:549:17: note: expanded from macro \u0027write\u0027\n  549 | #define  write  ___xxx_write\n      |                 ^\n```\n\nI think a blocking lint check would be the least hacky solution - I\u0027ve added them for some internal projects before. WDYT?",
      "parentUuid": "38db9b5b_205a9cdb",
      "revId": "a0fe50d90dabfc22d8247d8f7ba56e74e39368b0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}