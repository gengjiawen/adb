{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "a7f9d681_7ded8b29",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1076798
      },
      "writtenOn": "2021-11-02T02:32:27Z",
      "side": 1,
      "message": "This has some overlap with `adb attach/detach` which was added in https://android-review.googlesource.com/c/platform/packages/modules/adb/+/1739034\n\nAre you doing this because you need support for multiple adb servers on mac/windows?",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "48a4193a_c097ecf3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-11-02T15:27:22Z",
      "side": 1,
      "message": "i\u0027m uncomfortable with the idea of adding extra functionality to the \"not finished yet\" path... that\u0027s a bit too google3 \"this one is deprecated, that one isn\u0027t finished yet\" for me. right now we\u0027re mostly telling folks with libusb bugs \"don\u0027t do that then\", so giving users something that only works if you use libusb seems like a bad idea for both sides.\n\ncan we lift this up somewhere into code that\u0027s shared by both backends for now?\n\nat an even higher level, i\u0027m not entirely comfortable with the idea of adding functionality to adb to make it _lie_ to callers. sure, _you_ know what you\u0027re doing, but i\u0027m not sure we want to have to live in a world where everyone on the internet can accidentally get themselves into a position where `adb devices` is no longer a source of truth.\n\nwhy can\u0027t you just do any filtering in your test harness, which seems like the more traditional approach, and much less likely to have random fallout?",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5b4f15b8_a7f8c680",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-02T20:31:37Z",
      "side": 1,
      "message": "This supports running multiple parallel adb servers (possibly different versions) on Linux. (maybe mac in the future, but not likely)\n\nUsers use go/si-device-cloud to check out a device and use that device. We also proxy adb connections from the user\u0027s workstation to the remote host running thte adb server. Currently, when they check out a device and run adb devices, they very often get multiple devices in the list that don\u0027t belong to them (because we have several devices per host). This causes significant confusion.\n\nAlso, I really dislike the attach feature as implemented because most users/tools aren\u0027t familiar with adb attach and don\u0027t know they need to re-attach after every device reboot.\n\nI would argue that is doesn\u0027t lie to callers, but that it gives you exactly what you asked for when you set ADB_LIBUSB_FILTER before launching the server. What if adb devices is modified to print out a message indicating that the set of devices is limited to usb device addresses \u0027x,y,z\u0027 because of ADB_LIBUSB_FILTER is set. This is similar to the way ADB_VENDOR_KEYS outputs a troubleshooting message.\n\nIf you prefer, the attach feature could be modified to \n\n1) always reattach after device reboot\n2) support a list of USB device ids to auto attach (so no one ever has to call attach)\n3) another environment variable to control whether adb devices shows the entire list, or is filtered to attached devices\n\nor\n\n1) I could just remove the attach feature and we go with this one?",
      "parentUuid": "48a4193a_c097ecf3",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d0ade883_df7c9812",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-11-02T20:45:41Z",
      "side": 1,
      "message": "\u003e This supports running multiple parallel adb servers (possibly different versions) on Linux. (maybe mac in the future, but not likely)\n\nwhy? what\u0027s the bug _that\u0027s_ trying to solve?\n\n\u003e What if adb devices is modified to print out a message indicating that the set of devices is limited to usb device addresses \u0027x,y,z\u0027 because of ADB_LIBUSB_FILTER is set.\n\nor we could add a new \"filtered\" state to the `adb devices` display... that way parsers of `adb devices` output fail more gracefully too.\n\n(this still shouldn\u0027t be libusb-only though.)\n\n\u003e If you prefer, the attach feature could be modified to \n\u003e 1) always reattach after device reboot\n\u003e 2) support a list of USB device ids to auto attach (so no one ever has to call attach)\n\nhave you talked to the \"other internal engprods\" (android and google3) about this? because #1 does sound like something they would all have encountered, and i\u0027m curious what they think. (\"everyone says this would let them remove some flaky code\" would be a strong argument.) #2 sounds like we could have a new \"autoattach\" or whatever, so we wouldn\u0027t need to worry about breaking existing users. (though once again i\u0027m curious what other engprod groups are doing in that regard.)\n\n\u003e 3) another environment variable to control whether adb devices shows the entire list, or is filtered to attached devices\n\nheh, \"more environment variables\" is something i think we want to _avoid_ rather than promote :-)",
      "parentUuid": "5b4f15b8_a7f8c680",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "15063527_89ddc2fa",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-02T23:06:55Z",
      "side": 1,
      "message": "Device Cloud is meant to be capable of doing almost any kind of device access you could do locally. Users could use it to test new recovery packages, new bootloaders, new versions of adb, and new Android Builds, and new builds of LK.\n\nDevice hosts in device cloud usually have more than one Android device connected.\n\nSince different, parallel versions of adb are supported, we need different instances. Buggy versions of adb could hang or crash, and reduce the overall stability of tests.  Finally, and most importantly, many developers will run adb kill-server without thinking about it and interfere with other peoples\u0027 tests.\n\n\u003e or we could add a new \"filtered\" state to the `adb devices` display... that way parsers of `adb devices` output fail more gracefully too.\n\nThis is still confusing to users. They check out one device, they expect to see on device on adb devices. We are constantly explaining this to people. Your suggestion is an improvement, not a full fix.\n\n\u003e have you talked to the \"other internal engprods\" (android and google3) about this? because #1 does sound like something they would all have encountered\n\nhttps://groups.google.com/a/google.com/g/si-device-cloud-team/c/yF5_hIrO7yk/m/_t_KA2AnBAAJ?utm_medium\u003demail\u0026utm_source\u003dfooter\u0026pli\u003d1\n\nBack in the day, mobile ninjas wrote adb turbo to solve this and other issues I believe.\n\n\u003e  i\u0027m curious what other engprod groups are doing in that regard\n\nI would be surprised if anyone is using the feature as implemented. We can\u0027t.\n\n\u003e heh, \"more environment variables\" is something i think we want to _avoid_ rather than promote :-)\n\nADB_LIBUSB_DEVICES_LIE_TO_ME\u003d1\n\nHonestly, the architecture of adb silently forking a server run as user foo, that can be killed at any moment by user foo is inherently hostile to multi-user workflows. The auto-kill adb server on version mismatch is hostile. This aspect of adb has always really bothered me.",
      "parentUuid": "d0ade883_df7c9812",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c1b29ab_83c09abf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-02T23:20:23Z",
      "side": 1,
      "message": "I guess Mobile Harness works around this issue by forcing all users to a specific adb version.\n\nI dropped some time on your calendars tomorrow at 9AM. Please move somewhere else if that doesn\u0027t work for you. FYI, This is one change of many that fixes reliability issues with device cloud that are impacting the silicon org.",
      "parentUuid": "15063527_89ddc2fa",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "27b79740_da1797bf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1076798
      },
      "writtenOn": "2021-11-02T23:25:56Z",
      "side": 1,
      "message": "This seems like a fix in the wrong place though? Why not just create a container that only exposes the one device you selected and run adb in there?\n\n\u003e I would be surprised if anyone is using the feature as implemented. We can\u0027t.\n\nIt was implemented for MTaaS, I\u0027m guessing they\u0027re probably still using it? +williamhester",
      "parentUuid": "4c1b29ab_83c09abf",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2b824c36_1842124d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-02T23:31:35Z",
      "side": 1,
      "message": "multiple adb servers on Linux. (more discussion below)",
      "parentUuid": "a7f9d681_7ded8b29",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1e1dd1e3_bf84b3c6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-02T23:34:49Z",
      "side": 1,
      "message": "\u003e Why not just create a container that only exposes the one device you selected and run adb in there?\n\nFor the reasons I mentioned. The current architecture of adb doesn\u0027t provide any multi-user isolation or even isolation between tests on different devices run by the same user.\n\nThe solution to this should be to start to shift the design of adb, not use containers to work around it.",
      "parentUuid": "27b79740_da1797bf",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63f772b1_b97b0698",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-03T01:58:02Z",
      "side": 1,
      "message": "I\u0027ll look at the source to see if I can make this work in both paths.",
      "parentUuid": "1e1dd1e3_bf84b3c6",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ed94c6f2_28377d0d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1156333
      },
      "writtenOn": "2021-11-04T22:22:14Z",
      "side": 1,
      "message": "We explored using the feature for MTaaS, however we ultimately decided against this approach (adb attach/detach). We\u0027re currently working on manually resetting the USB device to forcefully kick it off the ADB server, because we found that the libusb version of ADB was too flaky.\n\nAnother solution I\u0027ve been exploring personally is treating the ADB server that\u0027s actually attached to the devices only as a proxy, and creating a fake adbd client that attaches to a second server. This allows Client -\u003e Server -\u003e Fake Device -\u003e Server -\u003e Real Device so that the server running closest to the client (in a container, remotely, etc) is only aware of one device. Mitchell Wills wrote this idea up in go/better-adb-port-forward-proxy. We plan on using it for sharing devices across a network and still allowing port forwarding to work, but I think it could also be used for isolation.",
      "parentUuid": "63f772b1_b97b0698",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "345e9ead_ab0acce5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1048574
      },
      "writtenOn": "2021-11-05T21:58:31Z",
      "side": 1,
      "message": "I was able to access an Android device from within a container. However, it was done by mapping /dev/bus/usb/00X/00Y to the container. I\u0027m concerned that the /dev/bus/usb/ will not be constant across device reboots, especially while other devices on the same bus may be rebooting.\n\nAlso, it doesn\u0027t look like docker supports dynamically mapping/unmapping devices into the containers without a restart. Also, slider/cloudripper USB devices like /dev/ttyACM? and /dev/ttyUSB? can absolutely change during device restart.",
      "parentUuid": "ed94c6f2_28377d0d",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "29782846_0aa32376",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1562318
      },
      "writtenOn": "2021-11-05T22:48:21Z",
      "side": 1,
      "message": "Using the /dev/bus/usb/00X/00Y route to map a device to a container isn\u0027t particular a good idea as if device gets disconnected or re-enumerated by the host the 00Y value typically changes (or increments upwards).\n\nThese devices may power cycle in the middle of session which means the 00Y value will change. This most consistent way of ensuring we get the same device each time when this occurs is to use the device address (e.g. 1-9.4.4) format noted above.\n\nUntil docker supports mounting a specific USB port, using docker to filter particular devices is not really feasible.",
      "parentUuid": "345e9ead_ab0acce5",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "aea430c3_0b8f9171",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-11-16T02:04:38Z",
      "side": 1,
      "message": "(sorry, very far behind atm...)\n\n\u003e Honestly, the architecture of adb silently forking a server run as user foo, that can be killed at any moment by user foo is inherently hostile to multi-user workflows. The auto-kill adb server on version mismatch is hostile. This aspect of adb has always really bothered me.\n\nit\u0027s not obvious there\u0027s an alternative to having the server, though, and although *test labs* might be fine/better off having their infrastructure handle that side of things, regular users struggle just using USB without having to deal with that themselves!\n\nbut the auto-kill shouldn\u0027t have happened in years ... the new \"adb features\" stuff means that most protocol extensions can now be dealt with dynamically. if you\u0027re not seeing that in practice, that\u0027s a separate bug/bugs and definitely worth investigation.\n\n\n\u003e We explored using the feature for MTaaS, however we ultimately decided against this approach (adb attach/detach).\n\nhmm... so two groups have kicked the tires of this and found it not usable... me might want to remove it if we don\u0027t think we can fix it?",
      "parentUuid": "29782846_0aa32376",
      "revId": "ef0127637079f076c877086eee7720582fd02e6f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}